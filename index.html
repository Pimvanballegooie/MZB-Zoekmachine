<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zoekmachine (fail-safe)</title>
<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0f172a; color:#e5e7eb; }
  .wrap { max-width: 1000px; margin: 0 auto; padding: 24px; }
  h1 { margin: 0 0 8px; font-size: 28px; }
  .panel { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; margin: 16px 0; }
  .row { display:grid; gap:12px; grid-template-columns: 1fr; }
  @media(min-width:900px){ .row { grid-template-columns: 1fr 1fr 1fr; } }
  label { font-size:14px; color:#94a3b8; display:block; margin:6px 0; }
  select, input { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:#e5e7eb; }
  button { padding:10px 14px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:#e5e7eb; cursor:pointer; margin-right:8px; }
  button:hover { border-color:#475569; }
  .chip { display:inline-block; margin:3px 6px 0 0; padding:6px 10px; border-radius:999px; background:#1f2937; border:1px solid #374151; font-size:12px; }
  table { width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:12px; }
  thead th { text-align:left; font-size:12px; color:#94a3b8; padding:0 10px; }
  tbody tr { background:#0b1220; border:1px solid #1f2937; }
  td { padding:10px; vertical-align:top; }
  .muted { color:#94a3b8; }
  .error { color:#fca5a5; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Zoek collega op Locatie & Categorie</h1>
  <div id="status" class="muted">Voorbereiden…</div>

  <div class="panel">
    <div>
      <button id="loadDirect">Opnieuw (direct laden)</button>
      <button id="loadProxy">Laden via proxy (aanbevolen)</button>
    </div>
  </div>

  <div class="panel">
    <div class="row">
      <div>
        <label>Locatie</label>
        <select id="loc" multiple size="6"></select>
      </div>
      <div>
        <label>Categorie</label>
        <select id="cat" multiple size="6"></select>
      </div>
      <div>
        <label>Zoek (naam/tekst)</label>
        <input id="q" placeholder="Typ om te zoeken…">
        <div style="margin-top:8px">
          <button id="clear">Wis filters</button>
          <button id="export">Exporteer CSV</button>
        </div>
        <div id="count" class="muted" style="margin-top:8px">0 resultaten</div>
        <div id="chips"></div>
      </div>
    </div>
  </div>

  <table>
    <thead><tr><th>Naam</th><th>Locaties</th><th>Categorieën</th></tr></thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjIWYvik5MqYcZV9R5jWEbkDRt72UFieHWtsiz85eoGVsIlrj6eieTKYbqcfgE2OaP3NvPjG22ovpn/pub?gid=1260760560&single=true&output=csv";
const PROXY   = "https://cors.isomorphic-git.org/";

const S = document.getElementById('status');
const L = document.getElementById('loc');
const C = document.getElementById('cat');
const Q = document.getElementById('q');
const R = document.getElementById('results');
const CNT = document.getElementById('count');
const CHIPS = document.getElementById('chips');

let DATA = [];

function setStatus(msg, isError=false){
  S.textContent = msg;
  S.className = isError ? 'error' : 'muted';
}

function parseCSV(text){
  const rows=[]; let row=[], field='', i=0, inQ=false;
  while(i<text.length){ const c=text[i];
    if(inQ){ if(c==='\"'){ if(text[i+1]==='\"'){ field+='\"'; i++; } else { inQ=false; } } else { field+=c; } }
    else { if(c==='\"'){ inQ=true; } else if(c===','){ row.push(field); field=''; }
           else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
           else if(c==='\r'){ } else { field+=c; } }
    i++;
  }
  if(field.length||inQ||row.length){ row.push(field); rows.push(row); }
  return rows;
}
function norm(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,' ').replace(/\n|\r/g,' '); }
function title(s){ return String(s||'').toLowerCase().replace(/\b\w/g,m=>m.toUpperCase()); }
function cleanLabel(s){ return title(String(s||'').replace(/\s*\([^)]*\)\s*/g,'')); }
function splitLoc(v){ const raw=String(v||'').trim(); if(!raw) return []; return raw.split(/[,;/]| en /i).map(x=>x.trim()).filter(Boolean); }
function isChecked(v){ const s=String(v||'').trim().toLowerCase(); return ['1','true','ja','yes','x','checked','waar','klopt','on'].includes(s); }

function populate(sel, items){ sel.innerHTML=''; items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); }
function selected(sel){ return Array.from(sel.selectedOptions).map(o=>o.value); }

function render(filters, data){
  CHIPS.innerHTML='';
  const addChip=(k,vals)=>vals.forEach(v=>{ const s=document.createElement('span'); s.className='chip'; s.textContent=`${k}: ${v}`; CHIPS.appendChild(s); });
  addChip('Loc', filters.locs); addChip('Cat', filters.cats);
  if(filters.q){ const s=document.createElement('span'); s.className='chip'; s.textContent=`Zoek: "${filters.q}"`; CHIPS.appendChild(s); }

  const out = data.filter(r=>{
    if(filters.locs.length){
      const set = new Set(r.locations.map(x=>x.toLowerCase()));
      if(!filters.locs.every(v=>set.has(v.toLowerCase()))) return false;
    }
    if(filters.cats.length){
      const set = new Set(r.categories.map(x=>x.toLowerCase()));
      if(!filters.cats.every(v=>set.has(v.toLowerCase()))) return false;
    }
    if(filters.q){
      const hay = [r.name, ...r.locations, ...r.categories].join(' | ').toLowerCase();
      if(!hay.includes(filters.q)) return false;
    }
    return true;
  });

  R.innerHTML='';
  out.forEach(r=>{
    const tr = document.createElement('tr');
    const n = document.createElement('td'); n.innerHTML = `<strong>${r.name}</strong>`;
    const l = document.createElement('td'); l.innerHTML = r.locations.map(x=>`<span class="chip">${x}</span>`).join(' ');
    const c = document.createElement('td'); c.innerHTML = r.categories.map(x=>`<span class="chip">${x}</span>`).join(' ');
    tr.appendChild(n); tr.appendChild(l); tr.appendChild(c); R.appendChild(tr);
  });
  CNT.textContent = `${out.length} resultaten`;
}

function rebuild(){
  const locs = Array.from(new Set(DATA.flatMap(r=>r.locations).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  const cats = Array.from(new Set(DATA.flatMap(r=>r.categories).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
  populate(L, locs); populate(C, cats);
  render({locs:[], cats:[], q:''}, DATA);
}

function buildFromRows(rows){
  if(!rows || !rows.length) throw new Error('Lege dataset');
  const header = rows[0].map(norm);
  const idx = needles => { for(let i=0;i<header.length;i++){ const h=header[i]; if(needles.some(n=>h.includes(n))) return i; } return -1; };

  const iName = idx(['naam','voor- en achternaam','achternaam','collega','naam?']);
  const iLoc  = idx(['locatie','op welke locatie','werk je','standplaats','vestiging']);
  if(iName<0 || iLoc<0) throw new Error('Kon verplichte kolommen niet vinden (Naam en Locatie).');

  const skip = new Set([iName,iLoc]);
  let iSpec = -1; const catCols=[];
  for(let c=0;c<header.length;c++){
    const h = header[c]; if(skip.has(c)) continue;
    if(h.includes('specifieke') || h.includes('specbeh')) { iSpec = c; continue; }
    if(/(kinder|geriatrie|psychosomatisch|chronische|cz|wervelkolom|benen|armen)/.test(h)){
      catCols.push({index:c, label: cleanLabel(rows[0][c])});
    }
  }

  const recs=[];
  for(let r=1;r<rows.length;r++){
    const row = rows[r]; if(!row || row.length===0) continue;
    const name = (row[iName]||'').toString().trim(); if(!name) continue;
    const locations = splitLoc(row[iLoc]||'');
    const mains=[]; for(const col of catCols){ if(isChecked(row[col.index])) mains.push(col.label); }
    const specs=[]; if(iSpec>=0){ const raw=(row[iSpec]||'').toString().trim();
      if(raw){ raw.split(',').forEach(p=>{ const clean=p.replace(/\s*\([^)]*\)\s*/g,'').trim(); if(clean) specs.push(cleanLabel(clean)); }); }
    }
    const categories = Array.from(new Set([...mains, ...specs])).sort((a,b)=>a.localeCompare(b));
    recs.push({ name, locations, categories });
  }
  DATA = recs;
  rebuild();
  setStatus('CSV geladen');
}

// events
document.getElementById('clear').addEventListener('click', ()=>{
  Array.from(L.options).forEach(o=>o.selected=false);
  Array.from(C.options).forEach(o=>o.selected=false);
  Q.value='';
  render({locs:[], cats:[], q:''}, DATA);
});
document.getElementById('export').addEventListener('click', ()=>{
  const filters={locs:selected(L), cats:selected(C), q:Q.value.trim().toLowerCase()};
  const out = DATA.filter(r=>{
    if(filters.locs.length){ const s=new Set(r.locations.map(x=>x.toLowerCase())); if(!filters.locs.every(v=>s.has(v.toLowerCase()))) return false; }
    if(filters.cats.length){ const s=new Set(r.categories.map(x=>x.toLowerCase())); if(!filters.cats.every(v=>s.has(v.toLowerCase()))) return false; }
    if(filters.q){ const hay=[r.name,...r.locations,...r.categories].join(' | ').toLowerCase(); if(!hay.includes(filters.q)) return false; }
    return true;
  });
  const rows = [['Naam','Locaties','Categorieën'], ...out.map(r=>[r.name, r.locations.join('; '), r.categories.join('; ')])];
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const a = document.createElement('a'); a.href=url; a.download='monne_zoekresultaten.csv'; a.click(); URL.revokeObjectURL(url);
});
L.addEventListener('change', ()=>render({locs:selected(L), cats:selected(C), q:Q.value.trim().toLowerCase()}, DATA));
C.addEventListener('change', ()=>render({locs:selected(L), cats:selected(C), q:Q.value.trim().toLowerCase()}, DATA));
Q.addEventListener('input', ()=>render({locs:selected(L), cats:selected(C), q:Q.value.trim().toLowerCase()}, DATA));

async function tryLoad(url){
  setStatus('CSV laden…');
  const res = await fetch(url);
  if(!res.ok) throw new Error('HTTP '+res.status);
  const text = await res.text();
  const rows = parseCSV(text);
  buildFromRows(rows);
}
async function loadDirect(){ try{ await tryLoad(CSV_URL); } catch(e){ setStatus('Direct laden faalde (CORS). Klik "Laden via proxy".', true); console.error(e); } }
async function loadProxy(){ try{ await tryLoad(PROXY+CSV_URL); setStatus('CSV geladen via proxy'); } catch(e){ setStatus('Ook via proxy mislukt.', true); console.error(e); } }

document.getElementById('loadDirect').addEventListener('click', loadDirect);
document.getElementById('loadProxy').addEventListener('click', loadProxy);

// automatisch: eerst direct; na 3s poging via proxy
let t = setTimeout(()=>{ if(S.textContent.includes('CSV laden')) loadProxy(); }, 3000);
loadDirect().then(()=>clearTimeout(t)).catch(()=>{});
</script>
</body>
</html>

