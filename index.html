<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monné Zoekmachine — Locatie & (Sub)Categorie met Match%</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
    --border:#1f2937; --chip:#162039; --chip-b:#22314f;
    --accent:#f97316; /* Monné oranje-accent */
    --good:#22c55e; --warn:#eab308; --bad:#f43f5e;
  }
  html,body{
    margin:0;background:var(--bg);color:var(--text);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial
  }
  .container{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{margin:0;font-size:clamp(18px,2.3vw,28px)}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:8px;background:var(--accent)}
  .sub{color:var(--muted)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
  .grid{display:grid;gap:12px}
  @media(min-width:1000px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"],select{
    width:100%;padding:10px 12px;border-radius:12px;
    border:1px solid var(--border);background:#0b1220;color:var(--text)
  }
  .btn{
    padding:10px 14px;border-radius:12px;border:1px solid var(--border);
    background:#0b1220;color:var(--text);cursor:pointer
  }
  .btn:hover{border-color:#2a3b5f}
  .btn-accent{background:var(--accent);border-color:#ef7d2a;color:#0b1020;font-weight:600}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{
    background:var(--chip);border:1px solid var(--chip-b);
    padding:6px 10px;border-radius:999px;font-size:12px
  }
  .chip .x{margin-left:6px;cursor:pointer;opacity:.7}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .status.error{color:var(--bad)}
  .typeahead{position:relative}
  .suggest{
    position:absolute;z-index:20;top:100%;left:0;right:0;
    background:#0b1220;border:1px solid var(--border);border-radius:12px;
    max-height:260px;overflow:auto
  }
  .suggest div{padding:8px 10px;border-bottom:1px solid #0e172b;cursor:pointer}
  .suggest div:hover{background:#101a32}
  .tag{font-size:11px;opacity:.8}
  table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
  thead th{text-align:left;font-size:12px;color:var(--muted);padding:0 12px}
  tbody tr{background:#0b1220;border:1px solid var(--border)}
  td{padding:12px;vertical-align:top}
  .name{font-weight:600}
  .meter{
    height:10px;background:#0e162b;border-radius:999px;
    overflow:hidden;border:1px solid var(--border)
  }
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),#f59e0b)}
  .kpi{display:flex;gap:10px;align-items:center}
  .badge{
    display:inline-block;padding:4px 8px;border-radius:999px;
    border:1px solid var(--chip-b);background:var(--chip);font-size:11px;margin-right:6px
  }
  .good{border-color:#1b7f3d;background:#0f2a1c;color:#a7f3d0}
  .warn{border-color:#7c6a12;background:#2a240f;color:#fde68a}
  .bad{border-color:#7f1d1d;background:#2a1111;color:#fecaca}
  .muted{color:var(--muted)}
  .footer{margin-top:16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Monné Zoekmachine</h1>
        <div class="sub">Locatie & (Sub)Categorie — Slim zoeken met match%</div>
      </div>
    </div>
  </header>

  <div class="panel">
    <div class="grid grid-3">
      <div>
        <label>Locatie (vrij zoeken)</label>
        <input id="locFree" type="text" placeholder="Typ bijv. 'Belcrum' of 'Ginneken'">
      </div>
      <div>
        <label>Locatie (selectie)</label>
        <select id="locSelect" size="6" multiple></select>
      </div>
      <div>
        <label>Categorie-zoeker (intelligent: hoofd & sub)</label>
        <div class="typeahead">
          <input id="catInput" type="text" placeholder="Typ bijv. 'Kinder' of 'Schouder'">
          <div id="suggest" class="suggest" style="display:none;"></div>
        </div>
        <div class="chips" id="activeCat"></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="reset" class="btn">Wis filters</button>
      <div id="status" class="status"></div>
    </div>
  </div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="muted" id="count">0 resultaten</div>
      <div class="muted">Sorteer op: Match% (hoog → laag)</div>
    </div>
    <table>
      <thead>
        <tr><th>Naam</th><th>Locaties</th><th>Categorieën</th><th style="width:260px">Match</th></tr>
      </thead>
      <tbody id="results"></tbody>
    </table>
    <div class="footer">
      Tip: meerdere locaties selecteren (Ctrl/Cmd-klik). De categorie-zoeker accepteert meerdere keuzes;
      klik op een chip om te verwijderen.
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG (OpenSheet) ===================== */
const DATA_URL = "https://opensheet.elk.sh/1Lixz4zd1EfYyRpqMB-5rN5yptCWJ2hxHboDiMulot10/1";  // Therapeuten
const TAX_URL  = "https://opensheet.elk.sh/1ccd4J-wAU7LOdvyr9zkvHpPhOOJan_OG7PXE2k0mM9g/1";  // Taxonomie

/* ===================== HELPERS ===================== */
function norm(s){ return String(s||"").trim().toLowerCase(); }
function titleCase(s){ return String(s||"").toLowerCase().replace(/\b\w/g,m=>m.toUpperCase()); }
function cleanLabel(s){ return titleCase(String(s||"").replace(/\s*\([^)]*\)\s*/g,"")); }
function splitLoc(v){
  const raw = String(v||"").trim();
  if(!raw) return [];
  return raw.split(/[,;/]| en /i).map(x=>x.trim()).filter(Boolean);
}
function isChecked(v){
  const s = norm(v);
  return ["1","true","ja","yes","x","checked","waar","klopt","on"].includes(s);
}

/* JSON (OpenSheet) → rows-array [ [head1,head2,..], [row1...], ... ] */
function jsonToRows(json){
  if(!json || !json.length) return [];
  const heads = Object.keys(json[0]);
  const rows = [heads];
  for(const obj of json){
    rows.push(heads.map(h => obj[h] ?? ""));
  }
  return rows;
}

/* ===================== STATE ===================== */
let TAX = { heads: [], subsByHead: {} };
let DATA = [];
let ALL_LOCS = [];
let ALL_CATS = [];        // {type:'head'|'sub', head, value, label}
let SELECTED_CATS = [];   // idem

/* ===================== DOM ===================== */
const els = {
  locFree:   document.getElementById("locFree"),
  locSelect: document.getElementById("locSelect"),
  catInput:  document.getElementById("catInput"),
  suggest:   document.getElementById("suggest"),
  activeCat: document.getElementById("activeCat"),
  reset:     document.getElementById("reset"),
  results:   document.getElementById("results"),
  count:     document.getElementById("count"),
  status:    document.getElementById("status"),
};

/* ===================== FETCH ===================== */
async function fetchSheetJSON(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error("HTTP "+res.status);
  return res.json();
}

/* ===================== TAXONOMIE ===================== */
function buildTaxonomyFromRows(rows){
  if(!rows || !rows.length) throw new Error("Lege taxonomie");
  const heads = rows[0].map(cleanLabel).filter(Boolean);
  const subsByHead = {};
  heads.forEach(h => subsByHead[h] = []);
  for(let r=1;r<rows.length;r++){
    const row = rows[r] || [];
    for(let c=0;c<heads.length;c++){
      const sub = cleanLabel(row[c] || "");
      if(sub) subsByHead[heads[c]].push(sub);
    }
  }
  TAX = { heads, subsByHead };

  const cats = [];
  heads.forEach(h=>{
    cats.push({type:"head", head:h, value:h, label:h});
    (subsByHead[h]||[]).forEach(s=>{
      cats.push({type:"sub", head:h, value:s, label:`${s} · ${h}`});
    });
  });
  ALL_CATS = cats;
}

/* ===================== DATA (THERAPEUTEN) ===================== */
function buildDataFromRows(rows){
  if(!rows || !rows.length) throw new Error("Lege data");
  const header = rows[0].map(h=>String(h||""));
  const headerNorm = header.map(h=>norm(h).replace(/\s+/g," ").replace(/\n|\r/g," "));

  const findCol = (needles) => {
    for(let i=0;i<headerNorm.length;i++){
      if(needles.some(n => headerNorm[i].includes(n))) return i;
    }
    return -1;
  };

  const iName = findCol(["naam","voor- en achternaam","achternaam","collega","naam?"]);
  const iLoc  = findCol(["locatie","op welke locatie","werk je","standplaats","vestiging"]);
  const iSpec = findCol(["specifieke behandelingen","specbeh","specifieke","behandelingen (specbeh)"]);

  if(iName<0 || iLoc<0) throw new Error("Kon verplichte kolommen niet vinden (Naam en Locatie).");

  const skip = new Set([iName,iLoc,iSpec].filter(x=>x>=0));
  const categoryColumns = [];
  for(let c=0;c<header.length;c++){
    if(skip.has(c)) continue;
    const label = cleanLabel(header[c]);
    if(label) categoryColumns.push({index:c,label});
  }

  const out = [];
  const locsSet = new Set();
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    if(!row || row.length===0) continue;
    const name = (row[iName]||"").toString().trim();
    if(!name) continue;

    const locations = splitLoc(row[iLoc]||"");
    locations.forEach(l=>locsSet.add(l));

    const mains = [];
    for(const col of categoryColumns){
      if(isChecked(row[col.index])) mains.push(col.label);
    }

    const specs = [];
    if(iSpec>=0){
      const raw=(row[iSpec]||"").toString().trim();
      if(raw){
        raw.split(",").forEach(p=>{
          const clean = cleanLabel(p);
          if(clean) specs.push(clean);
        });
      }
    }

    const categories = Array.from(new Set([...mains, ...specs]));
    out.push({ name, locations, categories, raw:{mains,specs} });
  }

  DATA = out;
  ALL_LOCS = Array.from(locsSet).sort((a,b)=>a.localeCompare(b));
}

/* ===================== UI HELPERS ===================== */
function populateLocations(){
  els.locSelect.innerHTML = "";
  ALL_LOCS.forEach(l=>{
    const o = document.createElement("option");
    o.value=l; o.textContent=l;
    els.locSelect.appendChild(o);
  });
}

function renderSuggestions(term){
  const box = els.suggest;
  box.innerHTML="";
  const t = norm(term);
  if(!t){ box.style.display="none"; return; }

  const taken = new Set(SELECTED_CATS.map(x=>x.type+":"+x.head+":"+x.value));
  const hits = ALL_CATS.filter(c=>{
    const hay = norm(c.label || c.value);
    return hay.includes(t) && !taken.has(c.type+":"+c.head+":"+c.value);
  }).slice(0,50);

  if(!hits.length){ box.style.display="none"; return; }

  hits.forEach(h=>{
    const row = document.createElement("div");
    row.innerHTML = `<strong>${h.value}</strong> <span class="tag">(${h.type==="head"?"hoofdcategorie":"sub"} • ${h.head})</span>`;
    row.addEventListener("click", ()=>{
      SELECTED_CATS.push(h);
      els.catInput.value="";
      box.style.display="none";
      renderActiveCats();
      applyFilters();
    });
    box.appendChild(row);
  });
  box.style.display="block";
}

function renderActiveCats(){
  const wrap = els.activeCat;
  wrap.innerHTML="";
  SELECTED_CATS.forEach((c,i)=>{
    const chip = document.createElement("span");
    chip.className="chip";
    chip.innerHTML = `${c.value} <span class="x" title="verwijderen">×</span>`;
    chip.querySelector(".x").addEventListener("click", ()=>{
      SELECTED_CATS.splice(i,1);
      renderActiveCats();
      applyFilters();
    });
    wrap.appendChild(chip);
  });
}

/* ===================== MATCHING ===================== */
function hasAnySubInHead(colleague, head){
  const subs = TAX.subsByHead[head]||[];
  return colleague.categories.some(c => subs.some(s=>norm(s)===norm(c)));
}
function hasExactSub(colleague, sub){
  return colleague.categories.some(c => norm(c)===norm(sub));
}
function matchesLocation(colleague, selected, free){
  let ok=false;
  if(selected.length){
    const set = new Set(colleague.locations.map(x=>norm(x)));
    ok = selected.some(v=>set.has(norm(v)));
  }
  if(!ok && free){
    const t = norm(free);
    ok = colleague.locations.some(l=>norm(l).includes(t));
  }
  return ok;
}

function scoreColleague(colleague){
  let points=0, possible=0;
  const notes=[];

  for(const f of SELECTED_CATS){
    if(f.type==="sub"){
      possible += 1;
      if(hasExactSub(colleague,f.value)){
        points += 1.0; notes.push({type:"good", txt:`Subcategorie: ${f.value}`});
      }else if(hasAnySubInHead(colleague,f.head)){
        points += 0.6; notes.push({type:"warn", txt:`Wel ${f.head}, andere sub`});
      }else{
        notes.push({type:"bad", txt:`Geen ${f.head}/${f.value}`});
      }
    }else if(f.type==="head"){
      possible += 1;
      if(hasAnySubInHead(colleague,f.head)){
        points += 1.0; notes.push({type:"good", txt:`Hoofdcategorie: ${f.head}`});
      }else{
        notes.push({type:"bad", txt:`Geen ${f.head}`});
      }
    }
  }

  const selLocs = Array.from(els.locSelect.selectedOptions).map(o=>o.value);
  const freeLoc = els.locFree.value.trim();
  if(selLocs.length || freeLoc){
    possible += 1;
    if(matchesLocation(colleague, selLocs, freeLoc)){
      points += 1.0; notes.push({type:"good", txt:`Locatie match`});
    }else{
      notes.push({type:"warn", txt:`Locatie mist`});
    }
  }

  const pct = possible>0 ? Math.round((points/possible)*100) : 0;
  return { pct, points, possible, notes };
}

/* ===================== RENDER ===================== */
function renderResults(list){
  els.results.innerHTML="";
  els.count.textContent = `${list.length} resultaten`;
  list.forEach(row=>{
    const tr = document.createElement("tr");

    const tdN = document.createElement("td");
    tdN.innerHTML = `<div class="name">${row.name}</div>`;
    tr.appendChild(tdN);

    const tdL = document.createElement("td");
    tdL.innerHTML = row.locations.map(l=>`<span class="chip">${l}</span>`).join(" ");
    tr.appendChild(tdL);

    const tdC = document.createElement("td");
    tdC.innerHTML = row.categories.map(c=>`<span class="chip">${c}</span>`).join(" ");
    tr.appendChild(tdC);

    const tdM = document.createElement("td");
    const meter = `
      <div class="kpi">
        <div style="min-width:46px;font-weight:600">${row._score.pct}%</div>
        <div class="meter" style="flex:1">
          <div class="bar" style="width:${row._score.pct}%"></div>
        </div>
      </div>
      <div style="margin-top:6px">
        ${row._score.notes.map(n=>`<span class="badge ${n.type}">${n.txt}</span>`).join(" ")}
      </div>
    `;
    tdM.innerHTML = meter;
    tr.appendChild(tdM);

    els.results.appendChild(tr);
  });
}

function applyFilters(){
  if(!DATA.length){ return; }
  const scored = DATA.map(d=>({ ...d, _score: scoreColleague(d) }))
                     .sort((a,b)=> b._score.pct - a._score.pct);
  renderResults(scored);
}

/* ===================== LOAD ALLES ===================== */
async function loadAll(){
  try{
    els.status.className = "status";
    els.status.textContent = "Data laden…";
    const [taxJson, dataJson] = await Promise.all([
      fetchSheetJSON(TAX_URL),
      fetchSheetJSON(DATA_URL)
    ]);
    const taxRows = jsonToRows(taxJson);
    const dataRows = jsonToRows(dataJson);

    buildTaxonomyFromRows(taxRows);
    buildDataFromRows(dataRows);
    populateLocations();
    els.status.textContent = "Data geladen.";
    applyFilters();
  }catch(e){
    console.error(e);
    els.status.className = "status error";
    els.status.textContent = "Fout bij laden: " + e.message +
      " (Controleer of de sheets gedeeld zijn met 'Iedereen met de link kan bekijken')";
  }
}

/* ===================== EVENTS ===================== */
els.reset.addEventListener("click", ()=>{
  els.locFree.value="";
  Array.from(els.locSelect.options).forEach(o=>o.selected=false);
  SELECTED_CATS.length=0;
  renderActiveCats();
  applyFilters();
});
els.catInput.addEventListener("input", e=>renderSuggestions(e.target.value));
document.addEventListener("click", (e)=>{
  if(!els.suggest.contains(e.target) && e.target!==els.catInput){
    els.suggest.style.display="none";
  }
});
els.locFree.addEventListener("input", applyFilters);
els.locSelect.addEventListener("change", applyFilters);

/* ===================== START ===================== */
loadAll();
</script>
</body>
</html>
