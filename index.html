<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monné Zoekmachine — Locatie & (Sub)Categorie met Match%</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
    --border:#1f2937; --chip:#162039; --chip-b:#22314f;
    --accent:#f97316; /* Monné oranje */
    --good:#22c55e; --warn:#eab308; --bad:#f43f5e;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{margin:0;font-size:clamp(18px,2.3vw,28px)}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:8px;background:var(--accent)}
  .sub{color:var(--muted)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
  .grid{display:grid;gap:12px}
  @media(min-width:1000px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"],select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text);cursor:pointer}
  .btn:hover{border-color:#2a3b5f}
  .btn-accent{background:var(--accent);border-color:#ef7d2a;color:#0b1020;font-weight:600}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:var(--chip);border:1px solid var(--chip-b);padding:6px 10px;border-radius:999px;font-size:12px}
  .chip .x{margin-left:6px;cursor:pointer;opacity:.7}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .status.error{color:var(--bad)}
  .typeahead{position:relative}
  .suggest{position:absolute;z-index:20;top:100%;left:0;right:0;background:#0b1220;border:1px solid var(--border);border-radius:12px;max-height:260px;overflow:auto}
  .suggest div{padding:8px 10px;border-bottom:1px solid #0e172b;cursor:pointer}
  .suggest div:hover{background:#101a32}
  .tag{font-size:11px;opacity:.8}
  table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
  thead th{text-align:left;font-size:12px;color:var(--muted);padding:0 12px}
  tbody tr{background:#0b1220;border:1px solid var(--border)}
  td{padding:12px;vertical-align:top}
  .name{font-weight:600}
  .meter{height:10px;background:#0e162b;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),#f59e0b)}
  .kpi{display:flex;gap:10px;align-items:center}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--chip-b);background:var(--chip);font-size:11px;margin-right:6px}
  .good{border-color:#1b7f3d;background:#0f2a1c;color:#a7f3d0}
  .warn{border-color:#7c6a12;background:#2a240f;color:#fde68a}
  .bad{border-color:#7f1d1d;background:#2a1111;color:#fecaca}
  .muted{color:var(--muted)}
  .footer{margin-top:16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Monné Zoekmachine</h1>
        <div class="sub">Locatie & (Sub)Categorie — Slim zoeken met match%</div>
      </div>
    </div>
    <button id="refresh" class="btn-accent">Vernieuw data</button>
  </header>

  <div class="panel">
    <div class="grid grid-3">
      <div>
        <label>Locatie (vrij zoeken)</label>
        <input id="locFree" type="text" placeholder="Typ bijv. 'Belcrum' of 'Ginneken'">
      </div>
      <div>
        <label>Locatie (selectie)</label>
        <select id="locSelect" size="6" multiple></select>
      </div>
      <div>
        <label>Categorie-zoeker (intelligent: hoofd & sub)</label>
        <div class="typeahead">
          <input id="catInput" type="text" placeholder="Typ bijv. 'Kinder' of 'Schouder'">
          <div id="suggest" class="suggest" style="display:none;"></div>
        </div>
        <div class="chips" id="activeCat"></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="reset" class="btn">Wis filters</button>
    </div>
  </div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="muted" id="count">0 resultaten</div>
      <div class="muted">Sorteer op: Match% (hoog → laag)</div>
    </div>
    <table>
      <thead>
        <tr><th>Naam</th><th>Locaties</th><th>Categorieën</th><th style="width:260px">Match</th></tr>
      </thead>
      <tbody id="results"></tbody>
    </table>
    <div class="footer">Automatisch bijgewerkt, of klik op "Vernieuw data" om direct te herladen.</div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const DATA_URL_DEFAULT = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQzg4Lc0Ffm3lmtQNSJPa5oPX3BMI0CNvWlhYuqT7u5zrtOlsG4-7urOd51M0TUg7DTvg-CH6GPm4_Q/pub?gid=1507012908&single=true&output=csv";
const TAX_URL_DEFAULT  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAKYnsb6ueKbE3RDv9K7rOztmmdZ9KheaEGM_-UUnrln5PAU-k8AeKFmZt16eUF0HfvNGfYMlX8tsH/pub?gid=0&single=true&output=csv";
const USE_PROXY = false;
const PROXY = "https://cors.isomorphic-git.org/";

/* ========== HULPFUNCTIES ========== */
function parseCSV(t){const r=[];let e=[],i="",o=0,n=!1;for(;o<t.length;){const l=t[o];if(n)'"'===l?'"'===t[o+1]?(i+='"',o++):n=!1:i+=l;else if('"'===l)n=!0;else if(","===l)e.push(i),i="";else if("\n"===l)e.push(i),r.push(e),e=[],i="";else if("\r"!==l)i+=l;o++}return(i.length||n||e.length)&&(e.push(i),r.push(e)),r}
function norm(s){return String(s||"").trim().toLowerCase()}
function cleanLabel(s){return String(s||"").replace(/\s*\([^)]*\)\s*/g,"").trim()}
function splitLoc(v){const raw=String(v||"").trim();return raw?raw.split(/[,;/]| en /i).map(x=>x.trim()).filter(Boolean):[]}
function isChecked(v){const s=norm(v);return["1","true","ja","yes","x","checked","waar","klopt","on"].includes(s)}

/* ========== STATE ========== */
let TAX={heads:[],subsByHead:{}},DATA=[],ALL_LOCS=[],ALL_CATS=[],SELECTED_CATS=[];
const els={locFree:locFree,locSelect:locSelect,catInput:catInput,suggest:suggest,activeCat:activeCat,reset:reset,results:results,count:count};

/* ========== FETCH ========== */
async function fetchCSV(url){const u=USE_PROXY?PROXY+url:url,res=await fetch(u);if(!res.ok)throw new Error("HTTP "+res.status);return parseCSV(await res.text())}

/* ========== TAXONOMIE ========== */
function buildTaxonomy(rows){
  const heads=rows[0].map(cleanLabel).filter(Boolean),subsByHead={};
  heads.forEach(h=>subsByHead[h]=[]);
  for(let r=1;r<rows.length;r++){const row=rows[r]||[];for(let c=0;c<heads.length;c++){const sub=cleanLabel(row[c]||"");if(sub)subsByHead[heads[c]].push(sub)}} 
  TAX={heads,subsByHead};
  const cats=[];heads.forEach(h=>{cats.push({type:"head",head:h,value:h,label:h});(subsByHead[h]||[]).forEach(s=>cats.push({type:"sub",head:h,value:s,label:`${s} · ${h}`}))});ALL_CATS=cats;
}

/* ========== DATA ========== */
function buildData(rows){
  const header=rows[0],headerNorm=header.map(h=>norm(h).replace(/\s+/g," "));
  const findCol=needles=>{for(let i=0;i<headerNorm.length;i++)if(needles.some(n=>headerNorm[i].includes(n)))return i;return-1};
  const iName=findCol(["naam","voor- en achternaam"]),iLoc=findCol(["locatie","werk"]),iSpec=findCol(["specifieke"]);
  const skip=new Set([iName,iLoc,iSpec].filter(x=>x>=0)),cols=[];for(let c=0;c<header.length;c++){if(!skip.has(c)){const l=cleanLabel(header[c]);if(l)cols.push({index:c,label:l})}}
  const out=[],locsSet=new Set();
  for(let r=1;r<rows.length;r++){const row=rows[r];if(!row)continue;const name=row[iName]?.trim();if(!name)continue;
    const locs=splitLoc(row[iLoc]);locs.forEach(l=>locsSet.add(l));
    const mains=cols.filter(c=>isChecked(row[c.index])).map(c=>c.label);
    const specs=iSpec>=0?(row[iSpec]||"").split(",").map(cleanLabel).filter(Boolean):[];
    out.push({name,locations:locs,categories:[...new Set([...mains,...specs])]});
  }
  DATA=out;ALL_LOCS=[...locsSet].sort()
}

/* ========== UI ========== */
function populateLocations(){locSelect.innerHTML="";ALL_LOCS.forEach(l=>{const o=document.createElement("option");o.value=l;o.textContent=l;locSelect.appendChild(o)})}
function renderSuggestions(t){const b=suggest;b.innerHTML="";const term=norm(t);if(!term){b.style.display="none";return}
  const taken=new Set(SELECTED_CATS.map(x=>x.type+":"+x.head+":"+x.value));
  const hits=ALL_CATS.filter(c=>norm(c.label).includes(term)&&!taken.has(c.type+":"+c.head+":"+c.value)).slice(0,50);
  if(!hits.length){b.style.display="none";return}
  hits.forEach(h=>{const d=document.createElement("div");d.innerHTML=`<strong>${h.value}</strong> <span class="tag">(${h.type==="head"?"hoofdcategorie":"sub"} • ${h.head})</span>`;
    d.onclick=()=>{SELECTED_CATS.push(h);catInput.value="";b.style.display="none";renderActiveCats();applyFilters()};b.appendChild(d)});
  b.style.display="block";
}
function renderActiveCats(){activeCat.innerHTML="";SELECTED_CATS.forEach((c,i)=>{const chip=document.createElement("span");chip.className="chip";chip.innerHTML=`${c.value} <span class='x'>×</span>`;chip.querySelector(".x").onclick=()=>{SELECTED_CATS.splice(i,1);renderActiveCats();applyFilters()};activeCat.appendChild(chip)})}

/* ========== MATCHING ========== */
function hasAnySubInHead(col,head){return col.categories.some(c=>TAX.subsByHead[head]?.some(s=>norm(s)===norm(c)))}
function hasExactSub(col,sub){return col.categories.some(c=>norm(c)===norm(sub))}
function matchesLocation(col,sel,free){let ok=false;if(sel.length){const set=new Set(col.locations.map(norm));ok=sel.some(v=>set.has(norm(v)))}if(!ok&&free){ok=col.locations.some(l=>norm(l).includes(norm(free)))}return ok}
function scoreCol(col){let p=0,max=0,notes=[];for(const f of SELECTED_CATS){if(f.type==="sub"){max++;if(hasExactSub(col,f.value)){p++;notes.push({t:"good",txt:`Sub: ${f.value}`})}else if(hasAnySubInHead(col,f.head)){p+=0.6;notes.push({t:"warn",txt:`Wel ${f.head}, andere sub`})}else notes.push({t:"bad",txt:`Geen ${f.head}/${f.value}`})}
  else if(f.type==="head"){max++;if(hasAnySubInHead(col,f.head)){p++;notes.push({t:"good",txt:`Hoofd: ${f.head}`})}else notes.push({t:"bad",txt:`Geen ${f.head}`})}}
  const sel=[...locSelect.selectedOptions].map(o=>o.value),free=locFree.value;if(sel.length||free){max++;if(matchesLocation(col,sel,free)){p++;notes.push({t:"good",txt:"Locatie match"})}else notes.push({t:"warn",txt:"Locatie mist"})}
  return{pct:max?Math.round(100*p/max):0,notes}}
function applyFilters(){const res=DATA.map(d=>({...d,_score:scoreCol(d)})).sort((a,b)=>b._score.pct-a._score.pct);renderResults(res)}
function renderResults(list){results.innerHTML="";count.textContent=list.length+" resultaten";list.forEach(r=>{const tr=document.createElement("tr");
  tr.innerHTML=`<td><div class='name'>${r.name}</div></td><td>${r.locations.map(l=>`<span class='chip'>${l}</span>`).join(" ")}</td>
  <td>${r.categories.map(c=>`<span class='chip'>${c}</span>`).join(" ")}</td>
  <td><div class='kpi'><div style='min-width:46px;font-weight:600'>${r._score.pct}%</div>
  <div class='meter' style='flex:1'><div class='bar' style='width:${r._score.pct}%'></div></div></div>
  <div style='margin-top:6px'>${r._score.notes.map(n=>`<span class='badge ${n.t}'>${n.txt}</span>`).join(" ")}</div></td>`;results.appendChild(tr)})}

/* ========== LADEN ========== */
async function loadAll(){try{const [tax,data]=await Promise.all([fetchCSV(TAX_URL_DEFAULT),fetchCSV(DATA_URL_DEFAULT)]);buildTaxonomy(tax);buildData(data);populateLocations();applyFilters()}catch(e){alert("Fout bij laden: "+e.message)}}
reset.onclick=()=>{locFree.value="";Array.from(locSelect.options).forEach(o=>o.selected=false);SELECTED_CATS.length=0;renderActiveCats();applyFilters()};
catInput.oninput=e=>renderSuggestions(e.target.value);
document.onclick=e=>{if(!suggest.contains(e.target)&&e.target!==catInput)suggest.style.display="none"};
locFree.oninput=applyFilters;locSelect.onchange=applyFilters;
refresh.onclick=loadAll;
loadAll();

/* ========== AUTO REFRESH ELKE 24 UUR ========== */
const AUTO_REFRESH_MS = 24 * 60 * 60 * 1000;
setInterval(() => { console.log("Automatisch verversen van data…"); loadAll();
