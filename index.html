<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monné Zoekmachine — Locatie & (Sub)Categorie met Match%</title>
<style>
  :root{
    --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
    --border:#1f2937; --chip:#162039; --chip-b:#22314f;
    --accent:#f97316; /* Monné oranje */
    --good:#22c55e; --warn:#eab308; --bad:#f43f5e;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
  .container{max-width:1200px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{margin:0;font-size:clamp(18px,2.3vw,28px)}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:8px;background:var(--accent)}
  .sub{color:var(--muted)}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
  .grid{display:grid;gap:12px}
  @media(min-width:1000px){.grid-3{grid-template-columns:1fr 1fr 1fr}}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"],select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text);cursor:pointer}
  .btn:hover{border-color:#2a3b5f}
  .btn-accent{background:var(--accent);border-color:#ef7d2a;color:#0b1020;font-weight:600}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .chip{background:var(--chip);border:1px solid var(--chip-b);padding:6px 10px;border-radius:999px;font-size:12px}
  .chip .x{margin-left:6px;cursor:pointer;opacity:.7}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .status.error{color:var(--bad)}
  .typeahead{position:relative}
  .suggest{position:absolute;z-index:20;top:100%;left:0;right:0;background:#0b1220;border:1px solid var(--border);border-radius:12px;max-height:260px;overflow:auto}
  .suggest div{padding:8px 10px;border-bottom:1px solid #0e172b;cursor:pointer}
  .suggest div:hover{background:#101a32}
  .tag{font-size:11px;opacity:.8}
  table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:12px}
  thead th{text-align:left;font-size:12px;color:var(--muted);padding:0 12px}
  tbody tr{background:#0b1220;border:1px solid var(--border)}
  td{padding:12px;vertical-align:top}
  .name{font-weight:600}
  .meter{height:10px;background:#0e162b;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),#f59e0b)}
  .kpi{display:flex;gap:10px;align-items:center}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--chip-b);background:var(--chip);font-size:11px;margin-right:6px}
  .good{border-color:#1b7f3d;background:#0f2a1c;color:#a7f3d0}
  .warn{border-color:#7c6a12;background:#2a240f;color:#fde68a}
  .bad{border-color:#7f1d1d;background:#2a1111;color:#fecaca}
  .muted{color:var(--muted)}
  .footer{margin-top:16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Monné Zoekmachine</h1>
        <div class="sub">Locatie & (Sub)Categorie — Slim zoeken met match%</div>
      </div>
    </div>
    <button id="refresh" class="btn-accent">Vernieuw data</button>
  </header>

  <div class="panel">
    <div class="grid grid-3">
      <div>
        <label>Locatie (vrij zoeken)</label>
        <input id="locFree" type="text" placeholder="Typ bijv. 'Belcrum' of 'Ginneken'">
      </div>
      <div>
        <label>Locatie (selectie)</label>
        <select id="locSelect" size="6" multiple></select>
      </div>
      <div>
        <label>Categorie-zoeker (intelligent: hoofd & sub)</label>
        <div class="typeahead">
          <input id="catInput" type="text" placeholder="Typ bijv. 'Kinder' of 'Schouder'">
          <div id="suggest" class="suggest" style="display:none;"></div>
        </div>
        <div class="chips" id="activeCat"></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="reset" class="btn">Wis filters</button>
    </div>
  </div>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="muted" id="count">0 resultaten</div>
      <div class="muted">Sorteer op: Match% (hoog → laag)</div>
    </div>
    <table>
      <thead>
        <tr><th>Naam</th><th>Locaties</th><th>Categorieën</th><th style="width:260px">Match</th></tr>
      </thead>
      <tbody id="results"></tbody>
    </table>
    <div class="footer">Automatisch bijgewerkt, of klik op "Vernieuw data" om direct te herladen.</div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const DATA_URL_DEFAULT = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQzg4Lc0Ffm3lmtQNSJPa5oPX3BMI0CNvWlhYuqT7u5zrtOlsG4-7urOd51M0TUg7DTvg-CH6GPm4_Q/pub?gid=1507012908&single=true&output=csv";
const TAX_URL_DEFAULT  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQAKYnsb6ueKbE3RDv9K7rOztmmdZ9KheaEGM_-UUnrln5PAU-k8AeKFmZt16eUF0HfvNGfYMlX8tsH/pub?gid=0&single=true&output=csv";

/* Proxy AAN i.v.m. mogelijke CORS/rechten blokkades */
const USE_PROXY = true;
const PROXY = "https://cors.isomorphic-git.org/";

/* ========== HULPFUNCTIES ========== */
function parseCSV(text){
  const rows=[]; let row=[], field='', i=0, q=false;
  while(i<text.length){
    const c=text[i];
    if(q){
      if(c==='\"'){ if(text[i+1]==='\"'){ field+='\"'; i++; } else { q=false; } }
      else { field+=c; }
    }else{
      if(c==='\"'){ q=true; }
      else if(c===','){ row.push(field); field=''; }
      else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; }
      else if(c!=='\r'){ field+=c; }
    }
    i++;
  }
  if(field.length||q||row.length){ row.push(field); rows.push(row); }
  return rows;
}
function norm(s){ return String(s||'').trim().toLowerCase(); }
function title(s){ return String(s||'').toLowerCase().replace(/\b\w/g,m=>m.toUpperCase()); }
function cleanLabel(s){ return title(String(s||'').replace(/\s*\([^)]*\)\s*/g,'')); }
function splitLoc(v){ const raw=String(v||'').trim(); if(!raw) return []; return raw.split(/[,;/]| en /i).map(x=>x.trim()).filter(Boolean); }
function isChecked(v){ const s=norm(v); return ['1','true','ja','yes','x','checked','waar','klopt','on'].includes(s); }

/* ========== STATE ========== */
let TAX={heads:[],subsByHead:{}}, DATA=[], ALL_LOCS=[], ALL_CATS=[], SELECTED_CATS=[];
const els={ locFree:document.getElementById('locFree'),
            locSelect:document.getElementById('locSelect'),
            catInput:document.getElementById('catInput'),
            suggest:document.getElementById('suggest'),
            activeCat:document.getElementById('activeCat'),
            reset:document.getElementById('reset'),
            results:document.getElementById('results'),
            count:document.getElementById('count'),
            refresh:document.getElementById('refresh') };

/* ========== FETCH ========== */
async function fetchCSV(url){
  const u = USE_PROXY ? (PROXY + url) : url;
  const res = await fetch(u);
  if(!res.ok) throw new Error('HTTP '+res.status);
  const txt = await res.text();
  return parseCSV(txt);
}

/* ========== TAXONOMIE ========== */
function buildTaxonomy(rows){
  if(!rows || !rows.length) throw new Error('Lege taxonomie CSV');
  const heads = rows[0].map(cleanLabel).filter(Boolean);
  const subsByHead = {};
  heads.forEach(h=>subsByHead[h]=[]);
  for(let r=1;r<rows.length;r++){
    const row = rows[r] || [];
    for(let c=0;c<heads.length;c++){
      const sub = cleanLabel(row[c]||"");
      if(sub) subsByHead[heads[c]].push(sub);
    }
  }
  TAX = { heads, subsByHead };
  const cats=[];
  heads.forEach(h=>{
    cats.push({type:'head', head:h, value:h, label:h});
    (subsByHead[h]||[]).forEach(s=>{
      cats.push({type:'sub', head:h, value:s, label:`${s} · ${h}`});
    });
  });
  ALL_CATS = cats;
}

/* ========== DATA (robuuste kolomherkenning) ========== */
function buildData(rows){
  if(!rows || !rows.length) throw new Error('Lege data CSV');
  const header = rows[0].map(h => String(h||''));
  const headerNorm = header.map(h=>norm(h).replace(/\s+/g,' ').replace(/\n|\r/g,' '));

  const findCol = (needles) => {
    for(let i=0;i<headerNorm.length;i++){
      if(needles.some(n => headerNorm[i].includes(n))) return i;
    }
    return -1;
  };

  /* UITGEBREIDE trefwoordenlijsten */
  const iName = findCol([
    'naam','naam collega','voor- en achternaam','voornaam','achternaam',
    'collega','medewerker','naam?','naam van collega'
  ]);
  const iLoc  = findCol([
    'locatie','locaties','locatie(s)','op welke locatie','werk je','werkzaam',
    'standplaats','vestiging','waar werk je','op welke locaties'
  ]);
  const iSpec = findCol([
    'specifieke behandelingen','spec beh','specbeh','specifieke',
    'behandelingen (specbeh)','spec-beh','spec behandelingen'
  ]);

  if(iName < 0 || iLoc < 0) throw new Error('Kon verplichte kolommen niet vinden (Naam en Locatie).');

  const skip = new Set([iName,iLoc,iSpec].filter(x=>x>=0));
  const categoryColumns = [];
  for(let c=0;c<header.length;c++){
    if(skip.has(c)) continue;
    const label = cleanLabel(header[c]);
    if(label) categoryColumns.push({index:c,label});
  }

  const out = [];
  const locsSet = new Set();
  for(let r=1;r<rows.length;r++){
    const row = rows[r];
    if(!row || row.length===0) continue;
    const name = (row[iName]||'').toString().trim();
    if(!name) continue;

    const locations = splitLoc(row[iLoc]||'');
    locations.forEach(l=>locsSet.add(l));

    const mains = [];
    for(const col of categoryColumns){
      if(isChecked(row[col.index])) mains.push(col.label);
    }

    const specs = [];
    if(iSpec >= 0){
      const raw=(row[iSpec]||'').toString().trim();
      if(raw){
        raw.split(',').forEach(p=>{
          const clean = cleanLabel(p);
          if(clean) specs.push(clean);
        });
      }
    }
    const categories = Array.from(new Set([...mains, ...specs]));
    out.push({ name, locations, categories });
  }

  DATA = out;
  ALL_LOCS = Array.from(locsSet).sort((a,b)=>a.localeCompare(b));
}

/* ========== UI ========== */
function populateLocations(){
  const sel = els.locSelect;
  sel.innerHTML = "";
  ALL_LOCS.forEach(l=>{
    const o = document.createElement('option');
    o.value=l; o.textContent=l;
    sel.appendChild(o);
  });
}
function renderSuggestions(term){
  const box = els.suggest;
  box.innerHTML="";
  const t = norm(term);
  if(!t){ box.style.display="none"; return; }

  const taken = new Set(SELECTED_CATS.map(x=>x.type+":"+x.head+":"+x.value));
  const hits = ALL_CATS.filter(c=>{
    const hay = norm(c.label || c.value);
    return hay.includes(t) && !taken.has(c.type+":"+c.head+":"+c.value);
  }).slice(0,50);

  if(hits.length===0){ box.style.display="none"; return; }

  hits.forEach(h=>{
    const row = document.createElement('div');
    row.innerHTML = `<strong>${h.value}</strong> <span class="tag">(${h.type==='head'?'hoofdcategorie':'sub'} • ${h.head})</span>`;
    row.addEventListener('click', ()=>{
      SELECTED_CATS.push(h);
      els.catInput.value="";
      box.style.display="none";
      renderActiveCats();
      applyFilters();
    });
    box.appendChild(row);
  });
  box.style.display="block";
}
function renderActiveCats(){
  const wrap = els.activeCat;
  wrap.innerHTML="";
  SELECTED_CATS.forEach((c,i)=>{
    const chip = document.createElement('span');
    chip.className="chip";
    chip.innerHTML = `${c.value} <span class="x" title="verwijderen">×</span>`;
    chip.querySelector('.x').addEventListener('click', ()=>{
      SELECTED_CATS.splice(i,1);
      renderActiveCats();
      applyFilters();
    });
    wrap.appendChild(chip);
  });
}

/* ========== MATCHING ========== */
function hasAnySubInHead(colleague, head){
  const subs = TAX.subsByHead[head]||[];
  return colleague.categories.some(c => subs.some(s=>norm(s)===norm(c)));
}
function hasExactSub(colleague, sub){
  return colleague.categories.some(c => norm(c)===norm(sub));
}
function matchesLocation(colleague, selected, free){
  let ok = false;
  if(selected.length){
    const set = new Set(colleague.locations.map(x=>norm(x)));
    ok = selected.some(v=>set.has(norm(v)));
  }
  if(!ok && free){
    const t = norm(free);
    ok = colleague.locations.some(l=>norm(l).includes(t));
  }
  return ok;
}
/* Scoring:
   - Per gekozen categorie:
       * sub: 1.0 als exact sub; 0.6 als andere sub binnenzelfde head; 0 anders
       * head: 1.0 als collega ≥1 sub in die head heeft; 0 anders
   - Locatie (als ingevuld): +1.0 bij match (vrij of selectie), 0 anders
   - Match% = (behaalde / mogelijke) * 100
*/
function scoreColleague(colleague){
  let points = 0, possible = 0;
  const notes = [];

  for(const f of SELECTED_CATS){
    if(f.type==='sub'){
      possible += 1;
      if(hasExactSub(colleague, f.value)){
        points += 1.0; notes.push({type:'good', txt:`Sub: ${f.value}`});
      }else if(hasAnySubInHead(colleague, f.head)){
        points += 0.6; notes.push({type:'warn', txt:`Wel ${f.head}, andere sub`});
      }else{
        notes.push({type:'bad', txt:`Geen ${f.head}/${f.value}`});
      }
    }else if(f.type==='head'){
      possible += 1;
      if(hasAnySubInHead(colleague, f.head)){
        points += 1.0; notes.push({type:'good', txt:`Hoofd: ${f.head}`});
      }else{
        notes.push({type:'bad', txt:`Geen ${f.head}`});
      }
    }
  }

  const selLocs = Array.from(els.locSelect.selectedOptions).map(o=>o.value);
  const freeLoc = els.locFree.value.trim();
  if(selLocs.length || freeLoc){
    possible += 1;
    if(matchesLocation(colleague, selLocs, freeLoc)){
      points += 1.0; notes.push({type:'good', txt:`Locatie match`});
    }else{
      notes.push({type:'warn', txt:`Locatie mist`});
    }
  }

  const pct = possible>0 ? Math.round((points/possible)*100) : 0;
  return { pct, notes };
}

/* ========== RENDER ========== */
function renderResults(list){
  els.results.innerHTML="";
  els.count.textContent = `${list.length} resultaten`;
  list.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="name">${r.name}</div></td>
      <td>${r.locations.map(l=>`<span class="chip">${l}</span>`).join(" ")}</td>
      <td>${r.categories.map(c=>`<span class="chip">${c}</span>`).join(" ")}</td>
      <td>
        <div class="kpi">
          <div style="min-width:46px;font-weight:600">${r._score.pct}%</div>
          <div class="meter" style="flex:1"><div class="bar" style="width:${r._score.pct}%"></div></div>
        </div>
        <div style="margin-top:6px">
          ${r._score.notes.map(n=>`<span class="badge ${n.type}">${n.txt}</span>`).join(" ")}
        </div>
      </td>`;
    els.results.appendChild(tr);
  });
}
function applyFilters(){
  const res = DATA.map(d=>({...d, _score:scoreColleague(d)}))
                  .sort((a,b)=> b._score.pct - a._score.pct);
  renderResults(res);
}

/* ========== LADEN ========== */
async function loadAll(){
  try{
    const [taxRows, dataRows] = await Promise.all([fetchCSV(TAX_URL_DEFAULT), fetchCSV(DATA_URL_DEFAULT)]);
    buildTaxonomy(taxRows);
    buildData(dataRows);
    populateLocations();
    applyFilters();
  }catch(e){
    alert("Fout bij laden: " + e.message);
  }
}

/* ========== EVENTS ========== */
els.reset.addEventListener('click', ()=>{
  els.locFree.value="";
  Array.from(els.locSelect.options).forEach(o=>o.selected=false);
  SELECTED_CATS.length=0;
  renderActiveCats();
  applyFilters();
});
els.catInput.addEventListener('input', e=>renderSuggestions(e.target.value));
document.addEventListener('click', (e)=>{
  if(!els.suggest.contains(e.target) && e.target!==els.catInput){
    els.suggest.style.display="none";
  }
});
els.locFree.addEventListener('input', applyFilters);
els.locSelect.addEventListener('change', applyFilters);
els.refresh.addEventListener('click', loadAll);

/* ========== INIT + AUTO REFRESH ========== */
loadAll();
const AUTO_REFRESH_MS = 24 * 60 * 60 * 1000;  // elke 24 uur
setInterval(() => { loadAll(); }, AUTO_REFRESH_MS);
</script>
</body>
</html>
